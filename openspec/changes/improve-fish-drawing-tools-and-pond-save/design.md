## 背景上下文

当前画板仅支持基础单色绘制与清空/提交，难以满足实际游戏中的绘制需求。本次变更同时要解决一个关键稳定性问题：用户保存完成后，鱼并不总能进入鱼塘可见状态。该问题横跨 `DrawingBoard`（绘制能力）与 `MultiPlayerController`（保存提交与入池编排），需要先明确技术方案以避免阶段切换和状态一致性回归。

约束：
- 需兼容现有 Cocos Creator 场景/预制体绑定方式。
- 需保持现有阶段流转（drawing / viewing / voting）。
- 工具栏视觉必须使用产品指定的画笔/橡皮/保存图标资源。

相关方：
- 玩家：需要可用、可控的绘制体验。
- 游戏系统：需要“保存成功即入池可见”的确定性行为。

## 目标 / 非目标

**目标：**
- 提供完整绘制工具：画笔/橡皮、颜色、笔触大小、撤销。
- 保持显式提交语义：仅保存动作可创建鱼。
- 确保保存成功后鱼数据稳定进入鱼塘/鱼池可见状态。
- 让新增工具能力可通过 scene-contract 测试验证。

**非目标：**
- 不重做整套绘制页面视觉布局（仅补齐必要控件与连接）。
- 不引入云端持久化、画作分享等扩展能力。
- 不改动战斗、投票、AI 生成等既有规则本身。

## 关键决策

1. **在 `DrawingBoard` 内建立工具状态单一数据源**
   - 决策：将当前模式（画笔/橡皮）、当前颜色、笔触大小、撤销历史统一收敛在 `DrawingBoard`。
   - 原因：降低跨组件状态分散导致的不一致。
   - 备选：放到 `MultiPlayerController` 统一管理。否决，因控制器已承担阶段编排职责，继续堆叠会导致职责混乱。

2. **撤销采用“笔画级历史重放”而非纹理快照**
   - 决策：记录笔画操作（模式、颜色、宽度、点集），撤销时按历史重建。
   - 原因：较纹理快照方案更节省内存，跨端行为更可控。
   - 备选：每次落笔保存位图快照。否决，内存与纹理生命周期成本更高。

3. **橡皮采用白色覆写策略**
   - 决策：橡皮模式以白色笔触覆写，背景维持白底。
   - 原因：与当前画布底色初始化一致，实现简单且稳定。
   - 备选：透明擦除/混合模式。否决，跨平台渲染差异与复杂度更高。

4. **保存作为唯一提交入口**
   - 决策：绘制过程只更新本地画布状态，只有保存动作触发鱼创建提交。
   - 原因：防止误触造成脏数据，符合用户“点保存才提交”的认知。
   - 备选：触摸结束自动提交。否决，易造成误创建与重复入池。

5. **加固入池链路并防重复提交**
   - 决策：在 `MultiPlayerController.onDrawingCompleted` 中做提交原子化处理（纹理注册、鱼数据插入、归属状态更新）并增加重复提交防护。
   - 原因：直接覆盖“画完后不入池”和“连点重复插入”两类问题。
   - 备选：仅在显示层做补救重试。否决，无法根治上游提交一致性问题。

6. **工具栏图标采用远程资源 + 本地兜底**
   - 决策：优先加载产品提供 URL，失败时回退占位资源并保持按钮可用。
   - 原因：满足产品资源要求，同时避免网络失败导致不可操作。
   - 备选：仅本地图标。否决，不满足当前资源指定约束。

## 风险与权衡

- **[风险] 撤销历史过长导致重放开销上升** → 缓解：限制历史长度并可合并细碎笔画点。
- **[风险] 远程图标加载失败造成可视缺失** → 缓解：提供本地兜底图并保证按钮文本/点击区可用。
- **[风险] 连续点击保存产生重复鱼记录** → 缓解：提交中禁用保存并引入提交令牌去重。
- **[风险] 场景节点绑定不一致导致工具失效** → 缓解：补充 scene-contract 对节点和组件绑定断言。
- **[风险] 白色橡皮与背景色配置不一致** → 缓解：统一背景色常量并复用于清屏与橡皮逻辑。

## 迁移计划

1. 通过 cocos-mcp 审核并补齐 `MultiPlayerScene` 绘制工具栏节点绑定（画笔/橡皮/保存/颜色/大小/撤销）。
2. 在 `DrawingBoard` 实现工具状态、历史记录与撤销重放能力。
3. 在 `MultiPlayerController` 落实显式保存提交与入池原子化处理、防重复机制。
4. 接入指定图标 URL 并补充资源加载失败兜底。
5. 扩展 scene-contract 与相关行为测试，覆盖色板约束与保存入池链路。
6. 回滚策略：若新工具能力引入回归，可临时关闭高级工具入口，保留基础保存入池主链路。

## 待确认问题

- 笔触大小应采用离散档位（如 3/6/10）还是滑杆连续值？
- 色板是否固定为当前 5 色，还是需要后续主题化配置入口？
- 移动端撤销操作是否需要最小触发间隔，避免误触连撤？
